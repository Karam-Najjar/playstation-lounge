<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/" text="رجوع"></ion-back-button>
    </ion-buttons>
    <ion-title>سجل الجلسات</ion-title>
    <ion-buttons slot="end">
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="download" slot="start"></ion-icon>
            تصدير البيانات
          </ion-card-title>
        </ion-card-header>

        <ion-card-content>
          <p class="ion-text-center ion-margin-bottom">اختر صيغة التصدير:</p>

          <ion-grid>
            <ion-row>
              <ion-col>
                <ion-button
                  expand="block"
                  color="primary"
                  (click)="exportData('json')"
                  [disabled]="filteredSessions().length === 0"
                >
                  <ion-icon name="document-text" slot="start"></ion-icon>
                  JSON
                </ion-button>
              </ion-col>
              <ion-col>
                <ion-button
                  expand="block"
                  color="danger"
                  (click)="exportData('pdf')"
                  [disabled]="filteredSessions().length === 0"
                >
                  <ion-icon name="document" slot="start"></ion-icon>
                  PDF
                </ion-button>
              </ion-col>
            </ion-row>
          </ion-grid>

          <div class="ion-text-center ion-margin-top" *ngIf="filteredSessions().length > 0">
            <small>
              <ion-icon name="information-circle" color="medium"></ion-icon>
              جاري تصدير {{ filteredSessions().length }} جلسة
            </small>
          </div>
        </ion-card-content>
      </ion-card>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Statistics Summary -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="stats-chart" slot="start"></ion-icon>
        الإحصائيات
      </ion-card-title>
    </ion-card-header>

    <ion-card-content>
      <ion-grid>
        <ion-row>
          <ion-col size="6">
            <div class="stat-item">
              <small>إجمالي الإيرادات</small>
              <h3>{{ formatCurrency(stats().totalRevenue) }}</h3>
            </div>
          </ion-col>
          <ion-col size="6">
            <div class="stat-item">
              <small>ساعات اللعب</small>
              <h3>{{ stats().totalHours }} ساعة</h3>
            </div>
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col size="6">
            <div class="stat-item">
              <small>عدد الجلسات</small>
              <h3>{{ stats().totalSessions }}</h3>
            </div>
          </ion-col>
          <ion-col size="6">
            <div class="stat-item">
              <small>المستحقات</small>
              <h3 [style.color]="stats().unpaidAmount > 0 ? 'var(--ion-color-danger)' : 'inherit'">
                {{ formatCurrency(stats().unpaidAmount) }}
              </h3>
            </div>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>

  <!-- Filters -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="filter" slot="start"></ion-icon>
        الفلاتر
      </ion-card-title>
    </ion-card-header>

    <ion-card-content>
      <!-- Date Filter -->
      <ion-list>
        <ion-item>
          <ion-label>الفترة الزمنية</ion-label>
          <ion-segment
            [(ngModel)]="selectedDate"
            (ionChange)="selectedDate.set($any($event).detail.value)"
          >
            <ion-segment-button value="today">
              <ion-label>اليوم</ion-label>
            </ion-segment-button>
            <ion-segment-button value="yesterday">
              <ion-label>أمس</ion-label>
            </ion-segment-button>
            <ion-segment-button value="week">
              <ion-label>أسبوع</ion-label>
            </ion-segment-button>
            <ion-segment-button value="month">
              <ion-label>شهر</ion-label>
            </ion-segment-button>
            <ion-segment-button value="custom">
              <ion-label>مخصص</ion-label>
            </ion-segment-button>
          </ion-segment>
        </ion-item>

        <!-- Custom Date Range -->
        <div *ngIf="selectedDate() === 'custom'" class="ion-padding-vertical">
          <ion-grid>
            <ion-row>
              <ion-col size="6">
                <ion-button expand="block" fill="outline" (click)="openDateModal('start')">
                  {{ startDate() || 'من تاريخ' }}
                </ion-button>
              </ion-col>
              <ion-col size="6">
                <ion-button expand="block" fill="outline" (click)="openDateModal('end')">
                  {{ endDate() || 'إلى تاريخ' }}
                </ion-button>
              </ion-col>
            </ion-row>
          </ion-grid>
        </div>

        <!-- Device Filter -->
        <ion-item>
          <ion-label>الجهاز</ion-label>
          <ion-select
            [(ngModel)]="selectedDevice"
            (ionChange)="selectedDevice.set($any($event).detail.value)"
            interface="action-sheet"
          >
            <ion-select-option *ngFor="let device of devices()" [value]="device">
              {{ device === 'all' ? 'جميع الأجهزة' : device }}
            </ion-select-option>
          </ion-select>
        </ion-item>

        <!-- Status Filter -->
        <ion-item>
          <ion-label>حالة الدفع</ion-label>
          <ion-select
            [(ngModel)]="selectedStatus"
            (ionChange)="selectedStatus.set($any($event).detail.value)"
            interface="action-sheet"
          >
            <ion-select-option *ngFor="let option of statusOptions()" [value]="option.value">
              {{ option.label }}
            </ion-select-option>
          </ion-select>
        </ion-item>
      </ion-list>

      <!-- Reset Button -->
      <ion-button expand="block" fill="outline" color="medium" (click)="resetFilters()">
        إعادة تعيين الفلاتر
      </ion-button>
    </ion-card-content>
  </ion-card>

  <!-- Sessions List -->
  <ion-card *ngIf="filteredSessions().length > 0">
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="receipt" slot="start"></ion-icon>
        الجلسات ({{ filteredSessions().length }})
      </ion-card-title>
    </ion-card-header>

    <ion-card-content>
      <ion-list>
        <ion-item
          *ngFor="let session of filteredSessions()"
          button
          [routerLink]="['/session', session.id]"
        >
          <ion-label>
            <h2>{{ session.deviceName }}</h2>
            <p>
              <ion-chip
                [color]="session.paymentStatus === 'paid' ? 'success' : 'warning'"
                size="small"
              >
                {{ session.paymentStatus === 'paid' ? 'مدفوعة' : 'غير مدفوعة' }}
              </ion-chip>
              <ion-chip color="primary" size="small" *ngIf="session.playerCount === '1-2'">
                1-2 لاعبين
              </ion-chip>
              <ion-chip color="secondary" size="small" *ngIf="session.playerCount === '3-4'">
                3-4 لاعبين
              </ion-chip>
            </p>
            <p>{{ session.customerName || 'عميل' }}</p>
            <p>{{ formatDate(session.createdAt) }}</p>
            <p *ngIf="session.endTime">
              المدة:
              {{
                formatDuration(
                  session.endTime.getTime() -
                    session.startTime.getTime() -
                    session.totalPausedDuration
                )
              }}
            </p>
          </ion-label>

          <ion-note slot="end" [color]="session.paymentStatus === 'paid' ? 'success' : 'medium'">
            {{ formatCurrency(calculateSessionTotal(session)) }}
          </ion-note>
        </ion-item>
      </ion-list>
    </ion-card-content>
  </ion-card>

  <!-- No Results -->
  <ion-card *ngIf="filteredSessions().length === 0">
    <ion-card-content class="ion-text-center ion-padding">
      <ion-icon name="search" size="large" color="medium"></ion-icon>
      <h3>لا توجد جلسات</h3>
      <p>لا توجد جلسات تطابق الفلاتر المحددة</p>
    </ion-card-content>
  </ion-card>
</ion-content>

<!-- Alert Component -->
<ion-alert
  [isOpen]="showAlert()"
  [header]="alertHeader()"
  [message]="alertMessage()"
  [buttons]="['حسناً']"
  (didDismiss)="showAlert.set(false)"
></ion-alert>

<!-- Date Selection Modal -->
<ion-modal [isOpen]="showDateModal()" (didDismiss)="showDateModal.set(false)">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>
          {{ dateModalType() === 'start' ? 'اختر تاريخ البدء' : 'اختر تاريخ الانتهاء' }}
        </ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="showDateModal.set(false)">إغلاق</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <ion-datetime
        [value]="dateModalType() === 'start' ? startDate() : endDate()"
        (ionChange)="onDateChange($event)"
        presentation="date"
        locale="ar-SA"
      ></ion-datetime>
    </ion-content>
  </ng-template>
</ion-modal>

