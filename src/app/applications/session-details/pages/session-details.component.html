<!-- Session not found -->
@if (!session()) {
  <div class="ion-text-center ion-padding">
    <h2>Ø§Ù„Ø¬Ù„Ø³Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©</h2>
    <p>ÙŠØªÙ… Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©...</p>
  </div>
}

<!-- Session Details -->
@if (session()) {
  <!-- Session Info Card -->
  <ion-card class="session-info-card">
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="game-controller" slot="start"></ion-icon>
        {{ session().deviceName }}
      </ion-card-title>
    </ion-card-header>

    <ion-card-content>
      <ion-grid>
        <ion-row>
          <ion-col size="6">
            <ion-text color="medium">
              <small>Ø§Ù„Ø¹Ù…ÙŠÙ„</small>
            </ion-text>
            <p class="info-value">{{ session().customerName || 'Ø¹Ù…ÙŠÙ„' }}</p>
          </ion-col>

          <ion-col size="6">
            <ion-text color="medium">
              <small>Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</small>
            </ion-text>
            <p>
              @if (session().playerCount === '1-2') {
                <ion-chip color="primary" class="player-chip">1-2 Ù„Ø§Ø¹Ø¨ÙŠÙ†</ion-chip>
              }
              @if (session().playerCount === '3-4') {
                <ion-chip color="secondary" class="player-chip">3-4 Ù„Ø§Ø¹Ø¨ÙŠÙ†</ion-chip>
              }
            </p>
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col size="6">
            <ion-text color="medium">
              <small>Ø¨Ø¯Ø£Øª ÙÙŠ</small>
            </ion-text>
            <p class="info-value">{{ formatTime(session().startTime) }}</p>
          </ion-col>

          <ion-col size="6">
            <ion-text color="medium">
              <small>Ø§Ù„Ù…Ø¯Ø©</small>
            </ion-text>
            <p class="info-value">{{ sessionDuration() }}</p>
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col size="12">
            <ion-text color="medium">
              <small>Ø§Ù„Ø³Ø¹Ø±</small>
            </ion-text>
            <p class="info-value">{{ getRateText() }}</p>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>

  <!-- Cost Summary -->
  <ion-card class="cost-card">
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="cash" slot="start"></ion-icon>
        Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠØ©
      </ion-card-title>
    </ion-card-header>

    <ion-card-content>
      <ion-list class="cost-list">
        <ion-item class="cost-item">
          <ion-label>ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆÙ‚Øª</ion-label>
          <ion-note slot="end" class="cost-note">{{ formatCurrency(sessionCost()) }}</ion-note>
        </ion-item>

        @if (session().orders.length > 0) {
          <ion-item class="cost-item">
            <ion-label>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</ion-label>
            <ion-note slot="end" class="cost-note">{{ formatCurrency(ordersTotal()) }}</ion-note>
          </ion-item>
        }

        <ion-item class="cost-item total-item">
          <ion-label><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</strong></ion-label>
          <ion-note slot="end" class="total-note">
            <strong>{{ formatCurrency(sessionTotal()) }}</strong>
          </ion-note>
        </ion-item>
      </ion-list>
    </ion-card-content>
  </ion-card>

  <!-- Orders List -->
  @if (session().orders.length > 0) {
    <ion-card class="orders-card">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="cafe" slot="start"></ion-icon>
          Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ©
        </ion-card-title>
      </ion-card-header>

      <ion-card-content>
        <ion-list class="orders-list">
          @for (order of session().orders; track order.id) {
            <ion-item class="order-item">
              <ion-label>
                <h3 class="order-name">{{ order.itemName }}</h3>
                <p class="order-details">{{ order.quantity }} Ã— {{ formatCurrency(order.unitPrice) }}</p>
              </ion-label>
              <ion-note slot="end" class="order-price">{{ formatCurrency(order.totalPrice) }}</ion-note>
            </ion-item>
          }
        </ion-list>
      </ion-card-content>
    </ion-card>
  }

  <!-- Action Buttons -->
  <ion-grid class="action-buttons">
    <ion-row>
      <!-- Pause/Resume Button -->
      @if (!session().endTime) {
        <ion-col size="6">
          <ion-button
            class="action-button"
            expand="block"
            [color]="session().isPaused ? 'success' : 'warning'"
            (click)="togglePause()"
          >
            <ion-icon [name]="session().isPaused ? 'play' : 'pause'" slot="start"></ion-icon>
            {{ session().isPaused ? 'Ø§Ø³ØªØ¦Ù†Ø§Ù' : 'Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª' }}
          </ion-button>
        </ion-col>
      }

      <!-- Add Order Button -->
      @if (!session().endTime) {
        <ion-col size="6">
          <ion-button class="action-button" expand="block" color="tertiary" (click)="addOrder()">
            <ion-icon name="add" slot="start"></ion-icon>
            Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨
          </ion-button>
        </ion-col>
      }

      <!-- End Session Button -->
      @if (!session().endTime) {
        <ion-col size="6">
          <ion-button class="action-button" expand="block" color="danger" (click)="endSession()">
            <ion-icon name="stop" slot="start"></ion-icon>
            Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©
          </ion-button>
        </ion-col>
      }

      <!-- Payment Status -->
      @if (session().endTime) {
        <ion-col size="6">
          <ion-button
            class="action-button"
            expand="block"
            [color]="session().paymentStatus === 'paid' ? 'success' : 'medium'"
            (click)="updatePaymentStatus(session().paymentStatus === 'paid' ? 'unpaid' : 'paid')"
          >
            <ion-icon name="card" slot="start"></ion-icon>
            {{ session().paymentStatus === 'paid' ? 'Ù…Ø¯ÙÙˆØ¹Ø©' : 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©' }}
          </ion-button>
        </ion-col>
      }
    </ion-row>
  </ion-grid>
}

<!-- Add Order Modal -->
<ion-modal [isOpen]="isAddingOrder()" (didDismiss)="isAddingOrder.set(false)" class="order-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="isAddingOrder.set(false)">Ø¥Ù„ØºØ§Ø¡</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content>
      <div class="modal-content">
        <ion-list class="modal-list">
          <ion-item class="modal-item">
            <ion-label position="stacked" class="modal-label">Ø§Ù„Ù…Ù†ØªØ¬</ion-label>
            <ion-select
              class="modal-select"
              [(ngModel)]="selectedProduct"
              aria-label="Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬"
              placeholder="Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬"
            >
              @for (product of products(); track product.id) {
                <ion-select-option [value]="product">
                  {{ product.name }} - {{ formatCurrency(product.price) }}
                </ion-select-option>
              }
            </ion-select>
          </ion-item>

          <ion-item class="modal-item">
            <ion-label position="stacked" class="modal-label">Ø§Ù„ÙƒÙ…ÙŠØ©</ion-label>
            <ion-input
              class="modal-input"
              [(ngModel)]="orderQuantity"
              type="number"
              min="1"
              placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©"
            ></ion-input>
          </ion-item>

          @if (selectedProduct()) {
            <ion-item class="modal-item">
              <ion-label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</ion-label>
              <ion-note slot="end" class="modal-total">
                {{ formatCurrency(selectedProduct()!.price * orderQuantity()) }}
              </ion-note>
            </ion-item>
          }
        </ion-list>

        <ion-button
          class="modal-button"
          expand="block"
          color="primary"
          (click)="confirmAddOrder()"
          [disabled]="!selectedProduct() || orderQuantity() < 1"
        >
          ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        </ion-button>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- End Session/Invoice Modal -->
<ion-modal [isOpen]="showEndSessionModal()" (didDismiss)="showEndSessionModal.set(false)" class="invoice-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¬Ù„Ø³Ø©</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="showEndSessionModal.set(false)">Ø¥ØºÙ„Ø§Ù‚</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content>
      <div class="modal-content">
        <!-- Invoice Content -->
        <ion-card class="invoice-card">
          <ion-card-header>
            <ion-card-title class="invoice-title">ğŸ® PlayStation Lounge</ion-card-title>
            <ion-card-subtitle class="invoice-subtitle">ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¬Ù„Ø³Ø©</ion-card-subtitle>
          </ion-card-header>

          <ion-card-content>
            <!-- Invoice Details -->
            <ion-grid class="invoice-grid">
              <ion-row class="invoice-row">
                <ion-col size="6" class="invoice-label">
                  <strong>Ø§Ù„Ø¬Ù‡Ø§Ø²:</strong>
                </ion-col>
                <ion-col size="6" class="invoice-value">
                  {{ session()?.deviceName }}
                </ion-col>
              </ion-row>

              <ion-row class="invoice-row">
                <ion-col size="6" class="invoice-label">
                  <strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong>
                </ion-col>
                <ion-col size="6" class="invoice-value">
                  {{ session()?.customerName || 'Ø¹Ù…ÙŠÙ„' }}
                </ion-col>
              </ion-row>

              <ion-row class="invoice-row">
                <ion-col size="6" class="invoice-label">
                  <strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†:</strong>
                </ion-col>
                <ion-col size="6" class="invoice-value">
                  {{ session()?.playerCount === '1-2' ? '1-2 Ù„Ø§Ø¹Ø¨ÙŠÙ†' : '3-4 Ù„Ø§Ø¹Ø¨ÙŠÙ†' }}
                </ion-col>
              </ion-row>

              <ion-row class="invoice-row">
                <ion-col size="6" class="invoice-label">
                  <strong>ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡:</strong>
                </ion-col>
                <ion-col size="6" class="invoice-value">
                  {{ formatDateTime(session()!.startTime) }}
                </ion-col>
              </ion-row>

              <ion-row class="invoice-row">
                <ion-col size="6" class="invoice-label">
                  <strong>ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</strong>
                </ion-col>
                <ion-col size="6" class="invoice-value">
                  {{ formatDateTime(session()!.endTime!) }}
                </ion-col>
              </ion-row>

              <ion-row class="invoice-row">
                <ion-col size="6" class="invoice-label">
                  <strong>Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©:</strong>
                </ion-col>
                <ion-col size="6" class="invoice-value">
                  {{ sessionDuration() }}
                </ion-col>
              </ion-row>

              <!-- Divider -->
              <ion-row class="invoice-divider">
                <ion-col>
                  <hr />
                </ion-col>
              </ion-row>

              <!-- Cost Breakdown -->
              <ion-row class="invoice-row">
                <ion-col size="6" class="invoice-label">ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆÙ‚Øª:</ion-col>
                <ion-col size="6" class="invoice-value">
                  {{ formatCurrency(sessionCost()) }}
                </ion-col>
              </ion-row>

              @if (ordersTotal() > 0) {
                <ion-row class="invoice-row">
                  <ion-col size="6" class="invoice-label">Ø§Ù„Ø·Ù„Ø¨Ø§Øª:</ion-col>
                  <ion-col size="6" class="invoice-value">
                    {{ formatCurrency(ordersTotal()) }}
                  </ion-col>
                </ion-row>
              }

              <!-- Divider -->
              <ion-row class="invoice-divider">
                <ion-col>
                  <hr />
                </ion-col>
              </ion-row>

              <!-- Total -->
              <ion-row class="invoice-total-row">
                <ion-col size="6" class="invoice-total-label">
                  <strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</strong>
                </ion-col>
                <ion-col size="6" class="invoice-total-value">
                  <strong>{{ formatCurrency(sessionTotal()) }}</strong>
                </ion-col>
              </ion-row>
            </ion-grid>

            <!-- Thank you message -->
            <div class="thank-you">
              <p>Ø´ÙƒØ±Ø§Ù‹ Ù„Ø²ÙŠØ§Ø±ØªÙƒÙ…! Ù†Ø±ØºØ¨ Ø¨Ø±Ø¤ÙŠØªÙƒÙ… Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ ğŸ®</p>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Action Buttons -->
        <ion-grid class="invoice-buttons">
          <ion-row>
            <ion-col size="6" size-md="4">
              <ion-button
                class="invoice-button"
                expand="block"
                color="success"
                (click)="updatePaymentStatus('paid'); showEndSessionModal.set(false)"
              >
                <ion-icon name="card" slot="start"></ion-icon>
                ØªÙ… Ø§Ù„Ø¯ÙØ¹
              </ion-button>
            </ion-col>
            <ion-col size="6" size-md="4">
              <ion-button
                class="invoice-button"
                expand="block"
                color="medium"
                (click)="updatePaymentStatus('unpaid'); showEndSessionModal.set(false)"
              >
                <ion-icon name="time" slot="start"></ion-icon>
                Ø¯ÙØ¹ Ù„Ø§Ø­Ù‚Ø§Ù‹
              </ion-button>
            </ion-col>
            @if (session()?.endTime) {
              <ion-col size="12" size-md="4">
                <ion-button class="invoice-button" expand="block" color="warning" (click)="exportInvoice()">
                  <ion-icon name="document" slot="start"></ion-icon>
                  ØªØµØ¯ÙŠØ± ÙØ§ØªÙˆØ±Ø©
                </ion-button>
              </ion-col>
            }
          </ion-row>
        </ion-grid>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Alert Component -->
<ion-alert
  [isOpen]="showAlert()"
  [header]="alertHeader()"
  [message]="alertMessage()"
  [buttons]="['Ø­Ø³Ù†Ø§Ù‹']"
  (didDismiss)="showAlert.set(false)"
></ion-alert>