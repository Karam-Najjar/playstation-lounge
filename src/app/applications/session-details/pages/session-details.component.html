<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/" text="ุฑุฌูุน"></ion-back-button>
    </ion-buttons>
    <ion-title>ุชูุงุตูู ุงูุฌูุณุฉ</ion-title>
  </ion-toolbar>
</ion-header>

  <!-- Session not found -->
  <div *ngIf="!session()" class="ion-text-center ion-padding">
    <h2>ุงูุฌูุณุฉ ุบูุฑ ููุฌูุฏุฉ</h2>
    <p>ูุชู ุงูุนูุฏุฉ ููุตูุญุฉ ุงูุฑุฆูุณูุฉ...</p>
  </div>

  <!-- Session Details -->
  <div *ngIf="session()">
    <!-- Session Info Card -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="game-controller" slot="start"></ion-icon>
          {{ session().deviceName }}
        </ion-card-title>
      </ion-card-header>

      <ion-card-content>
        <ion-grid>
          <ion-row>
            <ion-col size="6">
              <ion-text color="medium">
                <small>ุงูุนููู</small>
              </ion-text>
              <p>
                <strong>{{ session().customerName || 'ุนููู' }}</strong>
              </p>
            </ion-col>

            <ion-col size="6">
              <ion-text color="medium">
                <small>ุนุฏุฏ ุงููุงุนุจูู</small>
              </ion-text>
              <p>
                <ion-chip color="primary" *ngIf="session().playerCount === '1-2'">
                  1-2 ูุงุนุจูู
                </ion-chip>
                <ion-chip color="secondary" *ngIf="session().playerCount === '3-4'">
                  3-4 ูุงุนุจูู
                </ion-chip>
              </p>
            </ion-col>
          </ion-row>

          <ion-row>
            <ion-col size="6">
              <ion-text color="medium">
                <small>ุจุฏุฃุช ูู</small>
              </ion-text>
              <p>
                <strong>{{ formatTime(session().startTime) }}</strong>
              </p>
            </ion-col>

            <ion-col size="6">
              <ion-text color="medium">
                <small>ุงููุฏุฉ</small>
              </ion-text>
              <p>
                <strong>{{ sessionDuration() }}</strong>
              </p>
            </ion-col>
          </ion-row>

          <ion-row>
            <ion-col size="12">
              <ion-text color="medium">
                <small>ุงูุณุนุฑ</small>
              </ion-text>
              <p>
                <strong>{{ getRateText() }}</strong>
              </p>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>

    <!-- Cost Summary -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="cash" slot="start"></ion-icon>
          ุงูุชูุงุตูู ุงููุงููุฉ
        </ion-card-title>
      </ion-card-header>

      <ion-card-content>
        <ion-list>
          <ion-item>
            <ion-label>ุชูููุฉ ุงูููุช</ion-label>
            <ion-note slot="end">{{ formatCurrency(sessionCost()) }}</ion-note>
          </ion-item>

          <ion-item *ngIf="session().orders.length > 0">
            <ion-label>ุงูุทูุจุงุช</ion-label>
            <ion-note slot="end">{{ formatCurrency(ordersTotal()) }}</ion-note>
          </ion-item>

          <ion-item>
            <ion-label><strong>ุงููุฌููุน</strong></ion-label>
            <ion-note slot="end" color="primary">
              <strong>{{ formatCurrency(sessionTotal()) }}</strong>
            </ion-note>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Orders List -->
    <ion-card *ngIf="session().orders.length > 0">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="cafe" slot="start"></ion-icon>
          ุงูุทูุจุงุช ุงููุถุงูุฉ
        </ion-card-title>
      </ion-card-header>

      <ion-card-content>
        <ion-list>
          <ion-item *ngFor="let order of session().orders">
            <ion-label>
              <h3>{{ order.itemName }}</h3>
              <p>{{ order.quantity }} ร {{ formatCurrency(order.unitPrice) }}</p>
            </ion-label>
            <ion-note slot="end">{{ formatCurrency(order.totalPrice) }}</ion-note>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Action Buttons -->
    <ion-grid>
      <ion-row>
        <!-- Pause/Resume Button -->
        <ion-col size="6" *ngIf="!session().endTime">
          <ion-button
            expand="block"
            [color]="session().isPaused ? 'success' : 'warning'"
            (click)="togglePause()"
          >
            <ion-icon [name]="session().isPaused ? 'play' : 'pause'" slot="start"></ion-icon>
            {{ session().isPaused ? 'ุงุณุชุฆูุงู' : 'ุฅููุงู ูุคูุช' }}
          </ion-button>
        </ion-col>

        <!-- Add Order Button -->
        <ion-col size="6" *ngIf="!session().endTime">
          <ion-button expand="block" color="tertiary" (click)="addOrder()">
            <ion-icon name="add" slot="start"></ion-icon>
            ุฅุถุงูุฉ ุทูุจ
          </ion-button>
        </ion-col>

        <!-- End Session Button -->
        <ion-col size="6" *ngIf="!session().endTime">
          <ion-button expand="block" color="danger" (click)="endSession()">
            <ion-icon name="stop" slot="start"></ion-icon>
            ุฅููุงุก ุงูุฌูุณุฉ
          </ion-button>
        </ion-col>

        <!-- Payment Status -->
        <ion-col size="6" *ngIf="session().endTime">
          <ion-button
            expand="block"
            [color]="session().paymentStatus === 'paid' ? 'success' : 'medium'"
            (click)="updatePaymentStatus(session().paymentStatus === 'paid' ? 'unpaid' : 'paid')"
          >
            <ion-icon name="card" slot="start"></ion-icon>
            {{ session().paymentStatus === 'paid' ? 'ูุฏููุนุฉ' : 'ุบูุฑ ูุฏููุนุฉ' }}
          </ion-button>
        </ion-col>
      </ion-row>
    </ion-grid>
  </div>

<!-- Add Order Modal -->
<ion-modal [isOpen]="isAddingOrder()" (didDismiss)="isAddingOrder.set(false)">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>ุฅุถุงูุฉ ุทูุจ ุฌุฏูุฏ</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="isAddingOrder.set(false)">ุฅูุบุงุก</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

      <ion-list>
        <ion-item>
          <ion-label position="stacked">ุงูููุชุฌ</ion-label>
          <ion-select
            [(ngModel)]="selectedProduct"
            aria-label="ุงุฎุชุฑ ุงูููุชุฌ"
            placeholder="ุงุฎุชุฑ ุงูููุชุฌ"
          >
            <ion-select-option *ngFor="let product of products()" [value]="product">
              {{ product.name }} - {{ formatCurrency(product.price) }}
            </ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">ุงููููุฉ</ion-label>
          <ion-input
            [(ngModel)]="orderQuantity"
            type="number"
            min="1"
            placeholder="ุฃุฏุฎู ุงููููุฉ"
          ></ion-input>
        </ion-item>

        <ion-item *ngIf="selectedProduct()">
          <ion-label>ุงููุฌููุน</ion-label>
          <ion-note slot="end">
            {{ formatCurrency(selectedProduct()?.price * orderQuantity()) }}
          </ion-note>
        </ion-item>
      </ion-list>

      <ion-button
        expand="block"
        color="primary"
        (click)="confirmAddOrder()"
        [disabled]="!selectedProduct() || orderQuantity() < 1"
        class="ion-margin-top"
      >
        ุชุฃููุฏ ุงูุฅุถุงูุฉ
      </ion-button>
  </ng-template>
</ion-modal>

<!-- End Session/Invoice Modal -->
<ion-modal [isOpen]="showEndSessionModal()" (didDismiss)="showEndSessionModal.set(false)">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>ูุงุชูุฑุฉ ุงูุฌูุณุฉ</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="showEndSessionModal.set(false)">ุฅุบูุงู</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

      <!-- Invoice Content -->
      <ion-card>
        <ion-card-header>
          <ion-card-title class="ion-text-center"> ๐ฎ PlayStation Lounge </ion-card-title>
          <ion-card-subtitle class="ion-text-center"> ูุงุชูุฑุฉ ุงูุฌูุณุฉ </ion-card-subtitle>
        </ion-card-header>

        <ion-card-content>
          <!-- Invoice Details -->
          <ion-grid>
            <ion-row>
              <ion-col size="6">
                <strong>ุงูุฌูุงุฒ:</strong>
              </ion-col>
              <ion-col size="6" class="ion-text-end">
                {{ session().deviceName }}
              </ion-col>
            </ion-row>

            <ion-row>
              <ion-col size="6">
                <strong>ุงูุนููู:</strong>
              </ion-col>
              <ion-col size="6" class="ion-text-end">
                {{ session().customerName || 'ุนููู' }}
              </ion-col>
            </ion-row>

            <ion-row>
              <ion-col size="6">
                <strong>ุนุฏุฏ ุงููุงุนุจูู:</strong>
              </ion-col>
              <ion-col size="6" class="ion-text-end">
                {{ session().playerCount === '1-2' ? '1-2 ูุงุนุจูู' : '3-4 ูุงุนุจูู' }}
              </ion-col>
            </ion-row>

            <ion-row>
              <ion-col size="6">
                <strong>ููุช ุงูุจุฏุก:</strong>
              </ion-col>
              <ion-col size="6" class="ion-text-end">
                {{ formatDateTime(session().startTime) }}
              </ion-col>
            </ion-row>

            <ion-row>
              <ion-col size="6">
                <strong>ููุช ุงูุงูุชูุงุก:</strong>
              </ion-col>
              <ion-col size="6" class="ion-text-end">
                {{ formatDateTime(session().endTime!) }}
              </ion-col>
            </ion-row>

            <ion-row>
              <ion-col size="6">
                <strong>ุงููุฏุฉ ุงูุฅุฌูุงููุฉ:</strong>
              </ion-col>
              <ion-col size="6" class="ion-text-end">
                {{ sessionDuration() }}
              </ion-col>
            </ion-row>

            <!-- Divider -->
            <ion-row class="ion-margin-vertical">
              <ion-col>
                <hr />
              </ion-col>
            </ion-row>

            <!-- Cost Breakdown -->
            <ion-row>
              <ion-col size="6"> ุชูููุฉ ุงูููุช: </ion-col>
              <ion-col size="6" class="ion-text-end">
                {{ formatCurrency(sessionCost()) }}
              </ion-col>
            </ion-row>

            <ion-row *ngIf="ordersTotal() > 0">
              <ion-col size="6"> ุงูุทูุจุงุช: </ion-col>
              <ion-col size="6" class="ion-text-end">
                {{ formatCurrency(ordersTotal()) }}
              </ion-col>
            </ion-row>

            <!-- Divider -->
            <ion-row class="ion-margin-vertical">
              <ion-col>
                <hr />
              </ion-col>
            </ion-row>

            <!-- Total -->
            <ion-row>
              <ion-col size="6">
                <strong>ุงููุฌููุน:</strong>
              </ion-col>
              <ion-col size="6" class="ion-text-end">
                <strong>{{ formatCurrency(sessionTotal()) }}</strong>
              </ion-col>
            </ion-row>
          </ion-grid>

          <!-- Thank you message -->
          <div class="ion-text-center ion-margin-top">
            <p>ุดูุฑุงู ูุฒูุงุฑุชูู! ูุฑุบุจ ุจุฑุคูุชูู ูุฑุฉ ุฃุฎุฑู ๐ฎ</p>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Action Buttons -->
      <ion-grid>
        <ion-row>
          <ion-col>
            <ion-button
              expand="block"
              color="success"
              (click)="updatePaymentStatus('paid'); showEndSessionModal.set(false)"
            >
              <ion-icon name="card" slot="start"></ion-icon>
              ุชู ุงูุฏูุน
            </ion-button>
          </ion-col>
          <ion-col>
            <ion-button
              expand="block"
              color="medium"
              (click)="updatePaymentStatus('unpaid'); showEndSessionModal.set(false)"
            >
              <ion-icon name="time" slot="start"></ion-icon>
              ุฏูุน ูุงุญูุงู
            </ion-button>
          </ion-col>
          <ion-col size="6" *ngIf="session()?.endTime">
            <ion-button expand="block" color="warning" (click)="exportInvoice()">
              <ion-icon name="document" slot="start"></ion-icon>
              ุชุตุฏูุฑ ูุงุชูุฑุฉ
            </ion-button>
          </ion-col>
        </ion-row>
      </ion-grid>
  </ng-template>
</ion-modal>

<!-- Alert Component -->
<ion-alert
  [isOpen]="showAlert()"
  [header]="alertHeader()"
  [message]="alertMessage()"
  [buttons]="['ุญุณูุงู']"
  (didDismiss)="showAlert.set(false)"
></ion-alert>
